<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="author" content="inaship">
    <meta name="copyright" content="inaship">
    <meta name="description" content="個人的なテストの場">
    <meta name="keywords" content="">
    <meta name=”robots” content=”noindex,follow” />
    <!--<base href="http://inaship.github.com/">-->
    <link rel="stylesheet" type="text/css" href="../assets/css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.2.3/css/bulma.min.css.map">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <title>SGT35 - Index</title>
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script type="text/javascript">
      var sgtLW;  // 設定用変数
      var apiDomain;
      var authtext;
      // 外部ファイル読み込み
      function loadSetting(){
        $.ajaxSetup({async: false});
        $.getJSON("setting.json", function(json){
          sgtLW = json;
          apiDomain = sgtLW.api_domain;
          authtext = sgtLW.auth_pass;
        })
        $.ajaxSetup({async: true});
      }

      var apParam = {
        //swPoint: "35.3682,138.9374",
        //nePoint: "35.3679,138.9191",
        swPoint: "36.1769,138.9866",
        nePoint: "36.4369,139.4398",
        jisCode_city: "10204",
        jisCode_pref: "09,10",
        potekaId: "235",
        amedasId: "42302",
        zoomLevel: "10",
        x: "",
        y: "",
        datetime: "2015-11-26T19:30:00+00:00"
      };

      var watherJson;

      // 天気情報読み込み
      function getWatherJSON() {
        var elements = getCheckElements();
        var req = new XMLHttpRequest();
        req.onreadystatechange = function() {
          if(req.readyState == 4 && req.status == 200){ // サーバーからのレスポンスが完了し、かつ、通信が正常に終了した場合
            var resText = req.responseText;
            $('#dispArea').val(resText);
            watherJson = JSON.parse(resText);
            console.log("watherJson = " + JSON.stringify(watherJson));
          }
        };
        reqUrl = createRecUrl(elements);
        req.open("GET", reqUrl, false);
        req.setRequestHeader("X-POTEKA-Authorization", authtext);
        req.send(null);
      }

      // apiURLを生成
      function createRecUrl(el){
        var retVal;
        var s = Number($("#targetAPI").val());
        console.log("elements =" + el );
        console.log("s = " + s);
        var tgApi;
        switch(s){
          case 0 : tgApi = "/v1/area/real/ja/prefecture"
                         + "?jisCode=" + apParam["jisCode_pref"]
                         + "&element=" + el;
            break;
          case 1 : tgApi = "/v1/area/real/ja/city"
                         + "?jisCode=" + apParam["jisCode_city"]
                         + "&element=" + el;
            break;
          case 2 : tgApi = "/v1/point/real/ja/poteka"
                         + "?potekaId=" + apParam["potekaId"]
                         + "&element=" + el;
            break;
          case 3 : tgApi = "/v1/point/real/ja/amedas"
                         + "?amedasId=" + apParam["amedasId"]
                         + "&element=" + el;
            break;
          case 4 : tgApi = "/v1/area/real/rectangle"
                         + "?swPoint=" + apParam["swPoint"]
                         + "&nePoint=" + apParam["nePoint"]
                         + "&element=" + el;
            break;
          case 5 : tgApi = "/v1/point/real/ja/radar"
                         + "?zoomLevel=" + apParam["zoomLevel"]
                         + "&x=" + apParam["x"]
                         + "&y=" + apParam["y"]
                         + "&datetime=" + apParam["datetime"];
            break;
          case 6 : tgApi = "/v1/area/forecast/rectangle"
                         + "?swPoint=" + apParam["swPoint"]
                         + "&nePoint=" + apParam["nePoint"]
                         + "&element=" + el;
            break;
          default: tgApi = "/v1/area/real/ja/prefecture"
                         + "?jisCode=" + apParam["jisCode_pref"]
                         + "&element=" + el;
        }
        retVal = apiDomain + tgApi;
        console.log(retVal);
        return retVal;
      }

      // チェックしたエレメントを取得
      function getCheckElements() {
        var el = $('[class="elements"]:checked').map(function(){
          return $(this).val()
        }).get().join(',');
        return el;
      }

      function htmlJSON() {
        // 最初のキーの名前を取り出す
        var apiKey = watherJson[0];
        console.log("apiKey = " + JSON.stringify(watherJson));
        for(var i in watherJson){
          $("#dispDiv").append("<li><strong>" + watherJson[i].element + "</strong></li>");
          for(var j in watherJson[i].element){
            $("#dispDiv").append("<li>" + watherJson[i].element[j].elementName + "（" + watherJson[i].element[j].sampling + "</li>n");
          }
        }
      }

      // イニシャライズ
      $(function () {
        loadSetting();
      });
    </script>
  </head>
  <body>
    <div id="wapper">
      <div id="container">
        <div>SGT</div>
        <div>

            <div>
              <input type="checkbox" name="elementType" class="elements" value="temp" checked="checked">&nbsp;気温
              <input type="checkbox" name="elementType" class="elements" value="humi">&nbsp;湿度
              <input type="checkbox" name="elementType" class="elements" value="press_l">&nbsp;現地気圧
              <input type="checkbox" name="elementType" class="elements" value="press_s">&nbsp;海面気圧
              <input type="checkbox" name="elementType" class="elements" value="wind_d">&nbsp;風向
              <input type="checkbox" name="elementType" class="elements" value="solar">&nbsp;日射
              <br />
              <input type="checkbox" name="elementType" class="elements" value="rain">&nbsp;雨感
              <input type="checkbox" name="elementType" class="elements" value="rain_f">&nbsp;1時間雨量
              <input type="checkbox" name="elementType" class="elements" value="rain_i">&nbsp;降水強度
              <input type="checkbox" name="elementType" class="elements" value="rain_c">&nbsp;連続雨量
              <input type="checkbox" name="elementType" class="elements" value="wbgt">&nbsp;暑さ指数
              <input type="checkbox" name="elementType" class="elements" value="weather">&nbsp;天気
            </div>
            <div>
              <select id="targetAPI">
                <option value="0" selected="selected">都道府県指定データ</option>
                <option value="1">市町村指定データ</option>
                <option value="2">POTEKA指定データ</option>
                <option value="3">アメダス指定データ</option>
                <option value="4">矩形指定データ（real）</option>
                <option value="5">雨雲レーダー指定データ</option>
                <option value="6">矩形指定データ（forecast）</option>
              </select>
              <button onclick="getWatherJSON();">天気データを取得して表示</button>
            </div>
            <div>
              <textarea id="dispArea" class="textarea" rows="20" cols="50"></textarea>
            </div>
            <div id="dispDiv">

            </div>
            <div>
              <button onclick="htmlJSON();">取得した天気情報をHTMLに出力</button>
            </div>
        </div>
      </div>
      <footer>
        <p>&nbsp;</p>
      </footer>
    </div>
  </body>
</html>